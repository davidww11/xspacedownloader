<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹è½½åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #1a8cd8;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•ä¸åŒçš„ä¸‹è½½æ–¹æ³•</h2>
        <button onclick="testDirectDownload()">æµ‹è¯•ç›´æ¥ä¸‹è½½é“¾æ¥</button>
        <button onclick="testBlobDownload()">æµ‹è¯• Blob ä¸‹è½½</button>
        <button onclick="testAPIDownload()">æµ‹è¯• API ä¸‹è½½</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // Log function
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Test 1: Direct download link
        function testDirectDownload() {
            log('æµ‹è¯•ç›´æ¥ä¸‹è½½é“¾æ¥...');
            const a = document.createElement('a');
            a.href = 'data:text/plain;charset=utf-8,Hello%20World%21';
            a.download = 'test-direct.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            log('âœ… ç›´æ¥ä¸‹è½½è§¦å‘å®Œæˆ');
        }

        // Test 2: Blob download
        function testBlobDownload() {
            log('æµ‹è¯• Blob ä¸‹è½½...');
            const content = 'This is a test file created via Blob download method.';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test-blob.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
            log('âœ… Blob ä¸‹è½½è§¦å‘å®Œæˆ');
        }

        // Test 3: API download simulation
        function testAPIDownload() {
            log('æµ‹è¯• API ä¸‹è½½...');
            const testUrl = 'https://x.com/0xluffy_eth/status/1927557957694185879';
            
            fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: testUrl, format: 'mp4' })
            })
            .then(response => response.json())
            .then(data => {
                log('âœ… API å“åº”æˆåŠŸ');
                log(`è§†é¢‘æ ‡é¢˜: ${data.title}`);
                log(`å¯ç”¨æ ¼å¼æ•°é‡: ${data.formats ? data.formats.length : 0}`);
                
                if (data.formats && data.formats.length > 0) {
                    const format = data.formats[0];
                    log(`å°è¯•ä¸‹è½½ç¬¬ä¸€ä¸ªæ ¼å¼: ${format.quality}`);
                    log(`ä¸‹è½½ URL: ${format.url.substring(0, 50)}...`);
                    
                    // ä½¿ç”¨å¢å¼ºçš„ä¸‹è½½å‡½æ•°
                    downloadFile(format.url, format.filename);
                }
            })
            .catch(error => {
                log(`âŒ API æµ‹è¯•å¤±è´¥: ${error.message}`);
            });
        }

        // Enhanced download function (same as in main page)
        window.downloadFile = function(url, filename) {
            log(`å¼€å§‹ä¸‹è½½: ${filename}`);
            log(`URL: ${url.substring(0, 50)}...`);
            
            try {
                // Method 1: Try fetch and blob download
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        log('âœ… Fetch è¯·æ±‚æˆåŠŸï¼Œæ­£åœ¨åˆ›å»º Blob...');
                        return response.blob();
                    })
                    .then(blob => {
                        log(`âœ… Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°: ${blob.size} bytes`);
                        
                        // Create blob URL and download
                        const blobUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename || 'video.mp4';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Clean up blob URL
                        setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
                        
                        log('âœ… ä¸‹è½½é€šè¿‡ Fetch + Blob æ–¹æ³•æˆåŠŸè§¦å‘');
                    })
                    .catch(error => {
                        log(`âš ï¸ Fetch æ–¹æ³•å¤±è´¥: ${error.message}`);
                        log('ğŸ”„ å°è¯•ç›´æ¥ä¸‹è½½æ–¹æ³•...');
                        
                        // Method 2: Direct download link (fallback)
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename || 'video.mp4';
                        a.style.display = 'none';
                        a.setAttribute('target', '_self');
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        log('âœ… ç›´æ¥ä¸‹è½½æ–¹æ³•å·²è§¦å‘');
                    });
                
            } catch (error) {
                log(`âŒ ä¸‹è½½å®Œå…¨å¤±è´¥: ${error.message}`);
                
                // Last resort: try to open in new tab with download hint
                log('ğŸ†˜ å°è¯•æœ€åçš„å¤‡ç”¨æ–¹æ³•...');
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'video.mp4';
                link.target = '_blank';
                link.click();
                log('âœ… å¤‡ç”¨æ–¹æ³•å·²è§¦å‘ï¼ˆæ–°æ ‡ç­¾é¡µï¼‰');
            }
        };

        // Initial log
        log('ä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„ç§ä¸‹è½½æ–¹æ³•');
    </script>
</body>
</html> 